
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Millicast Multiviewer</title>
</head>
<body style="font-family: sans-serif; background: #111; color: white; padding: 2em">
  <h1>Millicast Multiviewer</h1>

  <label>Number of Streams</label>
  <select id="numStreams"></select>
  <div id="streamSelectors" style="margin-top: 1em;"></div>

  <label style="margin-top: 2em;">Preset Name</label>
  <input type="text" id="presetName" placeholder="Enter preset name" />

  <button onclick="savePreset()">ðŸ’¾ Save Preset</button>

  <label for="presetSelect" style="display:block; margin-top:2em;">Load a Preset</label>
  <select id="presetSelect">
    <option value="">-- Select a Preset --</option>
  </select>
  <button onclick="loadPreset()">ðŸ“¥ Load Preset</button>
  <button onclick="deletePreset()">ðŸ—‘ Delete Preset</button>

  <div class="viewer-grid" id="viewerGrid" style="margin-top: 3em; display: grid; gap: 1em;"></div>

  <script>
    const streamList = [
      { name: "Shawn 1", url: "https://viewer.millicast.com?streamId=snsuzX/CQTL1-W01STR001" },
      { name: "Shawn 2", url: "https://viewer.millicast.com?streamId=snsuzX/QTL08-W01STR004" },
      { name: "Backstage", url: "https://your-millicast-hosted-player-url3" },
      { name: "Tech Feed", url: "https://your-millicast-hosted-player-url4" }
    ];

    function updateSelectors(preset = []) {
      const count = parseInt(document.getElementById("numStreams").value);
      const streamSelectors = document.getElementById("streamSelectors");
      streamSelectors.innerHTML = "";

      for (let i = 0; i < count; i++) {
        const label = document.createElement("label");
        label.textContent = "Stream " + (i + 1);
        const select = document.createElement("select");
        select.name = "stream" + i;

        streamList.forEach(stream => {
          const option = document.createElement("option");
          option.value = stream.url;
          option.textContent = stream.name;
          if (preset[i] === stream.url) option.selected = true;
          select.appendChild(option);
        });

        streamSelectors.appendChild(label);
        streamSelectors.appendChild(select);
      }
    }

    function loadStreams() {
      const viewerGrid = document.getElementById("viewerGrid");
      viewerGrid.innerHTML = "";

      const selects = document.querySelectorAll("#streamSelectors select");
      const count = selects.length;
      if (count <= 2) viewerGrid.style.gridTemplateColumns = "1fr 1fr";
      else if (count <= 4) viewerGrid.style.gridTemplateColumns = "repeat(2, 1fr)";
      else viewerGrid.style.gridTemplateColumns = "repeat(3, 1fr)";

      selects.forEach(select => {
        const div = document.createElement("div");
        div.innerHTML = '<iframe src="' + select.value + '" width="100%" height="300" frameborder="0" allowfullscreen></iframe>';
        viewerGrid.appendChild(div);
      });
    }

    async function savePreset() {
      const name = document.getElementById("presetName").value.trim();
      if (!name) return alert("Enter a preset name");

      const selects = document.querySelectorAll("#streamSelectors select");
      const urls = Array.from(selects).map(s => s.value);
      const data = { count: selects.length, urls };

      try {
        const res = await fetch('/.netlify/functions/savePreset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, data })
        });

        const text = await res.text();
        const result = JSON.parse(text);
        alert(result.message || "Preset saved");
        rememberLastPreset(name);
        populatePresetDropdown();
      } catch (err) {
        alert("Failed to save preset: " + err.message);
      }
    }

    async function loadPreset() {
      const name = document.getElementById("presetSelect").value;
      if (!name) return;

      try {
        const res = await fetch(`/.netlify/functions/loadPreset?name=${encodeURIComponent(name)}`);
        const data = await res.json();
        if (res.status !== 200) return alert(data.error || "Not found");

        document.getElementById("numStreams").value = data.count;
        updateSelectors(data.urls);
        loadStreams();
        rememberLastPreset(name);
      } catch (err) {
        alert("Error loading preset: " + err.message);
      }
    }

    async function deletePreset() {
      const name = document.getElementById("presetSelect").value;
      if (!name) return alert("Select a preset to delete");
      if (!confirm("Delete preset '" + name + "'?")) return;

      try {
        const res = await fetch("/.netlify/functions/deletePreset", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });

        const result = await res.json();
        alert(result.message || "Deleted");
        populatePresetDropdown();
      } catch (err) {
        alert("Failed to delete: " + err.message);
      }
    }

    async function populatePresetDropdown() {
      try {
        const res = await fetch('/.netlify/functions/listPresets');
        const names = await res.json();
        const dropdown = document.getElementById("presetSelect");
        dropdown.innerHTML = '<option value="">-- Select a Preset --</option>';
        names.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          dropdown.appendChild(option);
        });
      } catch (err) {
        console.error("Failed to list presets:", err);
      }
    }

    function rememberLastPreset(name) {
      localStorage.setItem("lastPreset", name);
    }

    document.addEventListener("DOMContentLoaded", () => {
      for (let i = 1; i <= 10; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        if (i === 2) opt.selected = true;
        document.getElementById("numStreams").appendChild(opt);
      }

      document.getElementById("numStreams").addEventListener("change", () => updateSelectors());
      updateSelectors();

      populatePresetDropdown();

      const last = localStorage.getItem("lastPreset");
      if (last) {
        document.getElementById("presetSelect").value = last;
        loadPreset();
      }
    });
  </script>
</body>
</html>
